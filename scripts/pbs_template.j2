#!/bin/bash
# PBS script for {{ method_name }} parameter sweep
# Auto-generated from Jinja2 template - DO NOT EDIT DIRECTLY

#PBS -N {{ job_array_name }}
#PBS -l select=1:ncpus={{ ncpus }}:mem={{ mem }}:scratch_local={{ scratch_local }}
#PBS -l walltime={{ walltime }}
#PBS -J {{ start_index }}-{{ end_index }}
#PBS -o {{ logs_dir }}/{{ method_name }}_^array_index^.out
#PBS -e {{ logs_dir }}/{{ method_name }}_^array_index^.err
#PBS -m ae

# Exit immediately if a command exits with a non-zero status
set -eo pipefail

# Pre-flight checks
[[ -n "$SCRATCHDIR" ]] || {
    echo >&2 "FATAL: Variable SCRATCHDIR is not set. This script must be run via qsub."
    exit 1
}
[[ -n "$PBS_ARRAY_INDEX" ]] || {
    echo >&2 "FATAL: Variable PBS_ARRAY_INDEX is not set. This script must be submitted as a job array."
    exit 1
}

# Path definitions
STORAGE="{{ storage_path }}"
PROJECT_DIR="$STORAGE/{{ project_dir }}"
SWEEP_DIR="$PROJECT_DIR/{{ sweep_dir }}"
CONTAINER="$PROJECT_DIR/{{ container_name }}"
DATA_DIR="$PROJECT_DIR/{{ data_subdir }}"
RESULTS_BASE="$PROJECT_DIR/{{ results_subdir }}"

# Method-specific parameters file
PARAMS_FILE="$SWEEP_DIR/{{ method_name }}_parameters.txt"

# Local (scratch) paths
LOCAL_CONFIG_NAME="config.yaml"
LOCAL_DATA_DIR="data"

echo "============================================"
echo "AGS Parameter Sweep - {{ method_name }}"
echo "Job Array: {{ job_array_name }}"
echo "============================================"
echo "PBS Array Index: $PBS_ARRAY_INDEX"
echo "PBS Job ID: $PBS_JOBID"
echo "Node: $(hostname)"
echo "Start Time: $(date)"
echo "Resources: {{ ncpus }} CPUs, {{ mem }} RAM, {{ walltime }} walltime"
echo "============================================"

# Setup scratch directory
cd "$SCRATCHDIR" || {
    echo >&2 "FATAL: Could not change to scratch directory."
    exit 1
}

echo "Setting up scratch directory..."
rsync -a "$DATA_DIR/" "$LOCAL_DATA_DIR/" || {
    echo >&2 "FATAL: Failed to copy data."
    exit 2
}

cp "$PARAMS_FILE" . || {
    echo >&2 "FATAL: Could not copy parameters file."
    exit 2
}

# Get parameters for this job
params=$(sed -n "${PBS_ARRAY_INDEX}p" $(basename "$PARAMS_FILE") || true)
if [[ -z "$params" ]]; then
    echo >&2 "FATAL: No parameters found for array index ${PBS_ARRAY_INDEX}"
    exit 3
fi

# Parse parameters
read -r job_id method config_file simulation_range graph_types <<< "$params"

echo ""
echo "Job Configuration:"
echo "  Global Job ID: $job_id (Config: configs/$config_file)"
echo "  Method: $method"
echo "  Simulations: $simulation_range"
echo "  Graph Types: $graph_types"
echo ""

# Verify method matches
if [[ "$method" != "{{ method_name }}" ]]; then
    echo >&2 "ERROR: Method mismatch. Expected {{ method_name }}, got $method"
    exit 4
fi

# Copy config file
cp "$SWEEP_DIR/configs/$config_file" "$LOCAL_CONFIG_NAME" || {
    echo >&2 "FATAL: Could not copy config file: $config_file"
    exit 2
}

# Set up environment
export SINGULARITY_BINDPATH="$SCRATCHDIR,$RESULTS_BASE"
export PYTHONUNBUFFERED=1

# Execute the computation
echo "Starting computation..."

# Build graph types argument
graph_types_arg=""
if [[ -n "$graph_types" ]]; then
    # Convert comma-separated string to space-separated for bash array
    IFS=',' read -ra graph_types_array <<< "$graph_types"
    graph_types_arg="--graph-types ${graph_types_array[@]}"
fi

singularity exec "$CONTAINER" python3.11 /app/run.py \
    --methods "$method" \
    --config "$LOCAL_CONFIG_NAME" \
    --data-path "./$LOCAL_DATA_DIR" \
    --results-path "$RESULTS_BASE" \
    --simulations "$simulation_range" \
    $graph_types_arg

exit_status=$?

echo "============================================"
echo "Computation completed with exit status: $exit_status"
echo "End Time: $(date)"
echo "============================================"

exit $exit_status
